# 内存泄漏-多线程多实例拍照全局句柄导致

![image-20220809105125430](https://hanbabang-1311741789.cos.ap-chengdu.myqcloud.com/Pics/image-20220809105125430.png)

### 出现场景

集成侧在CAMX HAL层，使用DRQ内的线程池，来进行多线程多实例拍照。

### 问题1

如图所示，全局g_handle可能在拍照快时，后面的句柄覆盖前面，导致前面的句柄泄漏，无法释放。解法是将全局句柄换为成员句柄。
注意，如果使用全局句柄，集成侧采用问题2的方式进行加锁的话，也不会有问题（严格单线程）。

### 问题2

SDK侧本身只支持单线程拍照，则集成侧必须要给create、process、release一整套流程加锁。此时，即使SDK侧在3个接口用同一把锁管理，但对于集成侧的行为无济于事，因为集成侧如果不加锁（或仅在每个接口处加同一把锁，跟SDK一样），则可能拍照快时，实例1执行完create（获取锁释放锁）、实例2获取到锁去执行create（此时实例1的process阻塞），这样就会造成拍照紊乱，前面的照片阻塞出不来，后面的先出来等。如果SDK支持多线程，则不会出现这种情况，效果会提高很多。

